---
title: 微信移动端页面开发之视频
date: 2019-04-21 08:55:14
tags: Other
categories:
- Other
---
随着抖音和各大直播平台迅猛发展，视频逐渐成为了我们日常生活的一部分。在前端开发领域，PC 端和移动端网站播放视频，已经是家常便饭的事情。

然而，作为国内最大的交流平台微信，在上面进行视频的前端开发却有着不少的困难和兼容性问题。那么如何才能在微信上面，顺利地做出效果棒、兼容性好并且让用户满意的页面呢？本场 Chat 就来说说微信中视频的前端开发：

H5 Video 标签简单介绍
微信中的 Video
微信中使用 Video 进行前端开发
微信中 Video 交互事件
好用的 Video 插件
本 Chat 主要面向于前端开发者以及从事微信相关开发的人员。

<!-- more -->
说起视频相信大家都不陌生，作为前端开发者，我们并不需要关注视频本身；只要做到把视频正常地在页面播放出来，用户体验良好，就完成任务了。听起来好像很简单，但是由于浏览器（特别是移动端）的快速发展，前端视频的处理已经受到了广泛关注。

## H5 Video 标签简单介绍
在微信中，视频的处理都是用 Html5 的 video 标签，所以在讲微信中的视频之前，先来简单回顾一下 Html5 的 video 标签。

一个最简单的 video 标签，跟图片一样，一个 src 属性中填入视频地址即可。
```
<video src="video.mp3"></video>
```

video 支持三种视频格式： Ogg、MPEG4、WebM。每种视频格式都有很多编码方式，video 主要支持的是以下编码：

> 1. MP4 = MPEG 4文件使用 H264 视频编解码器和AAC音频编解码器
> 2. WebM = WebM 文件使用 VP8 视频编解码器和 Vorbis 音频编解码器
> 3. Ogg = Ogg 文件使用 Theora 视频编解码器和 Vorbis音频编解码器

Html5 发布后，video 多了几个可配置的属性：
1. autoplay：视频就绪后马上播放
2. controls：视频控制的控件是否出现（进度条等）
3. height：视频播放器的高度
4. width：视频播放器的宽度
5. loop： 循环播放
6. muted：静音
7. poster：视频封面图
8. preload： 视频在页面加载时进行加载

在html5 中，一个 video 标签包含的东西就是这些。看到这里，可能有小伙伴就会问了，我在微信中看到的 video 标签，好像不止这些东西呀。

没错，这也是前端处理视频最头疼的地方：各大浏览器的兼容性。

## 微信中的 Video
那么在微信中的 video 是怎么样的呢：[文档](https://x5.tencent.com/tbs/guide/video.html)

微信中的视频，多了以下几个重要的属性：

1. x5-video-player-type：启动同层 H5 播放器（微信浏览器中，有一个十分有趣的设定，播放中的视频会永远至于最顶层）。H5 同层浏览器开启之后，会让视频全屏展示，然后其他的 dom 元素就可以呈现在视频上

2. x5-video-orientation：开启了 x5-video-player-type 之后，可以设置 x5-video-orientation 属性。这个属性可以改变视频播放器的方向

3. x5­-video­-player­-fullscreen：全屏设置，设置为 true 防止横屏

4. x-webkit-airplay：视频支持 ios 的 AirPlay 功能

5. webkit-playsinline 和 playsinline：ios 特有，禁止全屏播放

6. x5-playsinline：安卓禁止全屏播放

微信中的 video 标签特有的属性，是微信根据 x5 内核开发出来的特性。只有在微信浏览器中，设置这些属性才会有效果。

> 微信中，poster 会出现无效的情况，只有部分手机能够显示。建议后台返回多一张视频的图片，然后用 div 覆盖在上面，这样做就没有兼容性问题。

## 微信中使用 Video 进行前端开发
介绍完 video 标签的各项属性之后，我们来看看如果要在微信中，放一个视频，应该怎么做。

开始写代码之前，先确定好一件事情：项目中的视频，是需要局部播放还是全屏播放。

### 局部播放
局部播放视频，效果其实就跟我们在 PC 中看视频效果一样，点击视频，视频会在我们指定的区别播放：
![](https://images.gitbook.cn/1d7f55b0-63dc-11e9-a881-0717c5aad8bc)

1. 首先我们是不需要全屏模式的，就是说 x5-video-player-type 和 x5­-video­-player­-fullscreen 不需要设置。

2. 设置 webkit-playsinline、playsinline 和 x5-playsinline 为 true，保证安卓和 ios 中都不会出现全屏

3. 设置视频其他属性，把视频放到指定的区域

> 通过这三步，视频就能在指定位置，局部播放了。播放视频的时候，要注意 3 点：
> 1. 微信中，一个页面只能播放一个视频
> 2. 视频播放后，会置于最顶层，避免大量出现混滚动
> 3. 视频自动播放存在兼容性问题，一般不设置

### 全屏播放
全屏播放视频，是微信特有的展示效果：
![](https://images.gitbook.cn/9bfcf7c0-63dd-11e9-ade8-01e5697c5fc4)

1. 首先我们是需要全屏模式的，x5-video-player-type 和 x5­-video­-player­-fullscreen 设置为true。

2. 设置 webkit-playsinline、playsinline 和 x5-playsinline 为 false，或者不设置

3. 根据需求，通过 x5-video-orientation 设置视频的方向

4. 设置视频其他属性，把视频放到指定的区域，再加上 dom 元素

> 这种模式下，视频的用户体验极佳，并且能够在视频上放 dom 元素，能够丰富视频的交互效果。这里有 2 点需要注意
> 1. 用 vue router 或者 react router 跳转路由，全屏会退出
> 2. 全屏需要点击视频播放才能启动

## 微信中 Video 交互事件
除了简单播放视频之外，现在有很多移动端的 h5 用丰富的交互效果来跟视频做互动，那么在微信中，怎么做到跟视频交互呢？

### 启动视频
微信中，启动视频只能通过点击的方式，其他方式（摇一摇等）都不行。而且视频自动播放还存在兼容性问题，所以点击现在几乎是唯一的播放视频的方式。

### 暂停视频以及播放结束
一般通过下面两个方法来获取视频播放的进度和是否播放结束，这两个方法一定要作用于 video 上。
```
video.addEventListener('timeupdate', function (e) {
  console.log(video.currentTime) // 当前播放的进度
})

video.addEventListener('ended', function (e) {
  // 播放结束时触发
})
```
如果需要通过点击按钮的方式来控制视频，那么可以使用这两个方法
```
video.play()
video.pause()
```

微信中，需要加上这段代码
```
wx.ready(function () {
  ...
})
```

### 全屏模式下视频交互
1. 如果使用全屏模式，视频播放之后，可以使用其他的方式来停止和播放视频（例如摇一摇）

2. 由于全屏模式下，视频不会置于顶层，所以可以通过视频上的 dom 元素来控制视频

3. 全屏模式后，即使视频停止，也不会自动退出全屏。需要通过下面代码退出：
```
var myVideo = document.getElementById('video');
myVideo.addEventListener('ended', function () {
    this.webkitExitFullScreen();
});
```

> 注意：
> - 建议多使用全屏模式进行视频操作，用户体验比较好
> - 视频跟音频都是只能播放一个
> - 注意视频会出现在顶层的情况，交互的元素不要跟视频重叠
> - 做好视频的预加载

## 好用的 Video 插件
说了这么多 video 的注意事项和兼容性问题，其实开发起来还是挺麻烦的，有没有一些插件能够帮我们解决这些问题呢，这里推荐一个我常用的视频插件：[chimee](http://chimee.org/)

这个视频插件是奇舞团开发的H5组件化播放器框架，它主要的特点是帮我们把大量的兼容性问题都解决，并且有专门为移动端开发的版本。使用方法也很简单，引入之后，新建一个类，传入一个 dom 容器即可，其他的参数跟 video 中的参数一样：

```
import ChimeePlayer from 'chimee-player';

new ChimeePlayer({
  wrapper: '#wrapper',  // video dom容器
  src: 'video.mp4',
  controls: true
});
```

而移动端中可以这样使用：
```
new ChimeeMobilePlayer({
  wrapper: '#wrapper',  // video dom容器
  src: 'video.mp4',
  autoplay: true,
  controls: true,
  playsInline: true,
  preload: 'auto',
  x5VideoPlayerFullscreen: true,
  x5VideoOrientation: 'landscape|portrait',
  xWebkitAirplay: true,
  muted: true,
  // removeInnerPlugins: ['chimeeMobiControlbar', 'chimeeState'] // 需要移除的插件
});
```
> 移动端跟普通的版本的区别，其实是新增了 chimee-plugin-mobile-controlbar 和chimee-plugin-mobile-state 这两个控件。这两个控件帮我们在全屏模式下，创建了进度条以及状态控制，并且提供了 removeInnerPlugins 方法让我们删除控件。

我日常使用中，用这个插件基本上能够解决80%的视频播放问题，特别是移动端上。而且效率很高，只需要根据文档来配置就可以了，省去了在网上搜索解决方案的时间。

除了这个插件之外，国内外还有很多好的视频插件，像 video.js。不过经过实践之后，还是 chimee 比较合适我们日常的需求，以及国内用户的使用习惯。

以上是我对于微信中，开发视频的一些总体和体会，有写的不对的或者什么建议，可以在 chat 中向我提问，或者私信我。